<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Assist</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-bg: #2a2a2a;
            --bybit-yellow: #f7931a;
            --bybit-orange: #ff6b35;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #707070;
            --success: #00d4aa;
            --error: #ff4757;
            --warning: #ffa502;
            --border: #333333;
            --glassmorphism: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas: 
                "sidebar header"
                "sidebar main";
            min-height: 100vh;
        }

        .header {
            grid-area: header;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dev-credit {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--accent-bg);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid var(--border);
        }

        .model-indicator {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar {
            grid-area: sidebar;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-history {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-item {
            padding: 12px 15px;
            background: var(--accent-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-item:hover {
            background: var(--glassmorphism);
            border-color: var(--bybit-yellow);
            transform: translateX(5px);
        }

        .chat-item.active {
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            color: var(--primary-bg);
        }

        .knowledge-base {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .kb-item {
            padding: 10px 12px;
            background: var(--accent-bg);
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kb-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .main-content {
            grid-area: main;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
        }

        .chat-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            gap: 30px;
        }

        .welcome-logo {
            font-size: 72px;
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            max-width: 600px;
            line-height: 1.6;
        }

        .capabilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 40px;
            width: 100%;
            max-width: 900px;
        }

        .capability-card {
            background: var(--glassmorphism);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .capability-card:hover {
            transform: translateY(-5px);
            border-color: var(--bybit-yellow);
            box-shadow: 0 20px 40px rgba(247, 147, 26, 0.2);
        }

        .capability-icon {
            font-size: 32px;
            color: var(--bybit-yellow);
            margin-bottom: 15px;
        }

        .capability-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .capability-desc {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .message {
            max-width: 85%;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-content {
            padding: 20px 25px;
            border-radius: 20px;
            position: relative;
            backdrop-filter: blur(20px);
        }

        .message.user .message-content {
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            color: var(--primary-bg);
        }

        .message.assistant .message-content {
            background: var(--glassmorphism);
            border: 1px solid var(--border);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .user-avatar {
            background: var(--accent-bg);
            color: var(--text-primary);
        }

        .assistant-avatar {
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            color: var(--primary-bg);
        }

        .references {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .references-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reference-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 13px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .reference-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .reference-icon {
            color: var(--bybit-yellow);
            font-size: 12px;
        }

        .input-container {
            padding: 20px 30px;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            position: relative;
            max-width: 100%;
        }

        .input-field {
            width: 100%;
            padding: 18px 60px 18px 20px;
            background: var(--accent-bg);
            border: 2px solid var(--border);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            min-height: 56px;
            max-height: 120px;
            overflow-y: auto;
        }

        .input-field:focus {
            border-color: var(--bybit-yellow);
            box-shadow: 0 0 0 3px rgba(247, 147, 26, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            border: none;
            border-radius: 50%;
            color: var(--primary-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .send-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 10px 30px rgba(247, 147, 26, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: var(--bybit-yellow);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--bybit-yellow);
            font-weight: 600;
        }

        .error-message {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success-message {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .disclaimer-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .disclaimer-badge:hover {
            color: var(--bybit-yellow);
        }

        .disclaimer-icon {
            color: var(--bybit-yellow);
            font-size: 12px;
        }

        .new-chat-btn {
            background: linear-gradient(45deg, var(--bybit-yellow), var(--bybit-orange));
            color: var(--primary-bg);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 26, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "main";
            }
            
            .sidebar {
                display: none;
            }
            
            .capabilities {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                padding: 20px;
            }
            
            .input-container {
                padding: 15px 20px;
            }

            .chat-item, .kb-item, .reference-item {
                padding: 15px;
            }
            
            .send-button {
                width: 48px;
                height: 48px;
            }
            
            .input-field {
                padding: 15px 60px 15px 20px;
            }
        }

        .loading-skeleton {
            animation: skeleton-loading 1.5s infinite;
            background: linear-gradient(90deg, var(--accent-bg) 25%, rgba(255,255,255,0.1) 50%, var(--accent-bg) 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <span>Bybit Assist</span>
            </div>
            <div class="header-controls">
                <div class="dev-credit">Developed by N. Thomas</div>
                <div class="model-selector">
                    <div class="model-indicator"></div>
                    <span>Mistral 7B</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </header>

        <aside class="sidebar">
            <button class="new-chat-btn" onclick="clearChat()">
                <i class="fas fa-plus"></i> New Chat
            </button>

            <div class="sidebar-section">
                <div class="sidebar-title">Recent Chats</div>
                <div class="chat-history" id="chatHistory">
                    <!-- Chat history will be added dynamically -->
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Knowledge Base</div>
                <div class="knowledge-base">
                    <div class="kb-item">
                        <div class="kb-status"></div>
                        <span>Trading Documentation</span>
                    </div>
                    <div class="kb-item">
                        <div class="kb-status"></div>
                        <span>Account Management</span>
                    </div>
                    <div class="kb-item">
                        <div class="kb-status"></div>
                        <span>API & Developers</span>
                    </div>
                    <div class="kb-item">
                        <div class="kb-status"></div>
                        <span>Payment Methods</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">System Stats</div>
                <div class="stats-bar">
                    <div class="stat-item">
                        <i class="fas fa-database"></i>
                        <span class="stat-value">98.5%</span>
                        <span>Accuracy</span>
                    </div>
                </div>
                <div class="stats-bar">
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span class="stat-value">0.8s</span>
                        <span>Avg Response</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-logo">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div class="welcome-title">Bybit RAG Assistant</div>
                    <div class="welcome-subtitle">
                        Get instant answers about trading, account management, API integration, and all Bybit platform features.
                    </div>
                    
                    <div class="capabilities">
                        <div class="capability-card" onclick="askSampleQuestion('How do I deposit funds into my Bybit account?')">
                            <div class="capability-icon">
                                <i class="fas fa-money-bill-transfer"></i>
                            </div>
                            <div class="capability-title">Deposits & Withdrawals</div>
                            <div class="capability-desc">Guide to funding your account and withdrawing assets</div>
                        </div>
                        
                        <div class="capability-card" onclick="askSampleQuestion('How does Bybit P2P trading work?')">
                            <div class="capability-icon">
                                <i class="fas fa-people-arrows"></i>
                            </div>
                            <div class="capability-title">P2P Trading</div>
                            <div class="capability-desc">Learn about peer-to-peer trading on Bybit</div>
                        </div>
                        
                        <div class="capability-card" onclick="askSampleQuestion('What is Bybit Pay and how do I use it?')">
                            <div class="capability-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="capability-title">Bybit Pay</div>
                            <div class="capability-desc">Using Bybit's payment solutions</div>
                        </div>
                        
                        <div class="capability-card" onclick="askSampleQuestion('How do I complete KYC verification on Bybit?')">
                            <div class="capability-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="capability-title">Account Verification</div>
                            <div class="capability-desc">KYC process and requirements</div>
                        </div>

                        <div class="capability-card" onclick="askSampleQuestion('How do I use Bybit API for automated trading?')">
                            <div class="capability-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="capability-title">API Development</div>
                            <div class="capability-desc">Building applications with Bybit API</div>
                        </div>

                        <div class="capability-card" onclick="askSampleQuestion('What are the trading pairs available on Bybit?')">
                            <div class="capability-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="capability-title">Market Information</div>
                            <div class="capability-desc">Available trading instruments and pairs</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="input-field" 
                        placeholder="Ask anything about Bybit - trading, account, API, payments, or platform features..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                        aria-label="Message input"
                    ></textarea>
                    <button class="send-button" onclick="sendMessage()" id="sendButton" aria-label="Send message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let isTyping = false;
        let messageHistory = [];
        let cleanupFunctions = [];
        let resizeTimeout;
        let currentChatTitle = null;

        function sanitize(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function autoResize(textarea) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                textarea.style.height = '56px';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }, 100);
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askSampleQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen && welcomeScreen.style) {
                welcomeScreen.style.display = 'none';
            }
        }

        // Mock AI response for testing (without API calls)
        async function getAIStreamResponse(prompt) {
            const chatContainer = document.getElementById('chatContainer');
            let fullResponse = '';
            
            // Create assistant message container
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-avatar assistant-avatar" aria-hidden="true">
                            <i class="fas fa-headset"></i>
                        </div>
                        <span>Bybit Assist</span>
                        <span style="margin-left: auto; font-size: 12px; opacity: 0.7;">
                            ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    </div>
                    <div class="message-text" id="streamingResponse"></div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            
            try {
                // Mock responses covering all Bybit features
                const mockResponses = {
                    "How do I deposit funds into my Bybit account?": `To deposit funds into your Bybit account:
                    
1. Log in to your Bybit account
2. Go to "Assets" → "Deposit"
3. Select your preferred deposit method (crypto or fiat)
4. Follow the on-screen instructions

<b>Crypto Deposits:</b>
• Supported networks vary by asset
• Always check the deposit address carefully

<b>Fiat Deposits:</b>
• Available through various payment methods
• May require KYC verification

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`,
                    
                    "How does Bybit P2P trading work?": `Bybit P2P trading allows direct transactions between users:

1. <b>Access P2P Platform:</b> Navigate to "Buy Crypto" → "P2P Trading"
2. <b>Select Offer:</b> Choose from available buy/sell offers
3. <b>Initiate Trade:</b> Enter amount and payment details
4. <b>Complete Transaction:</b> Follow escrow instructions

Key Features:
• Competitive pricing from multiple merchants
• Escrow protection for both parties
• Multiple payment methods supported

Learn more: <a href="https://www.bybit.com/en-US/p2p/" target="_blank">Bybit P2P Official Page</a>

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`,
                    
                    "What is Bybit Pay and how do I use it?": `Bybit Pay is a crypto payment solution:

<b>How to Use:</b>
1. Ensure you have sufficient crypto balance
2. Select Bybit Pay at checkout with supported merchants
3. Confirm transaction details
4. Complete payment

Features:
• Instant crypto-to-fiat conversion
• Supports multiple cryptocurrencies
• Secure transactions with merchant verification

For merchants: <a href="https://www.bybit.com/en-US/pay/" target="_blank">Bybit Pay Integration Guide</a>

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`,
                    
                    "How do I complete KYC verification on Bybit?": `Bybit KYC Verification Steps:

1. Log in to your Bybit account
2. Go to "Account & Security" → "Identity Verification"
3. Select your country/region
4. Provide required documents:
   • Government-issued ID
   • Facial verification
5. Submit for review (typically takes <24 hours)

<b>Note:</b> KYC requirements vary by region and product usage.

Official Guide: <a href="https://www.bybit.com/en-US/help-center/article/KYC-Verification" target="_blank">Bybit KYC Documentation</a>

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`,
                    
                    "How do I use Bybit API for automated trading?": `Bybit API Integration Guide:

1. <b>Generate API Keys:</b>
   • Navigate to "API Management"
   • Create keys with appropriate permissions
   • Set IP whitelist for security

2. <b>Connect to API:</b>
   • Use official <a href="https://bybit-exchange.github.io/docs/" target="_blank">API documentation</a>
   • Choose between REST or WebSocket

3. <b>Implement Trading Logic:</b>
   • Follow rate limits (100 requests/10s)
   • Include proper error handling

For troubleshooting: <a href="https://bybit-exchange.github.io/docs/faq" target="_blank">API FAQ</a>

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`,
                    
                    "What are the trading pairs available on Bybit?": `Bybit offers diverse trading pairs across:

<b>Spot Trading:</b>
• BTC/USDT, ETH/USDT, and 100+ pairs
• Regular new listings

<b>Derivatives:</b>
• Perpetual contracts (BTCUSD, ETHUSD, etc.)
• Linear contracts (BTCUSDT, ETHUSDT)
• Inverse contracts

View all markets: <a href="https://www.bybit.com/en-US/markets/" target="_blank">Bybit Markets Page</a>

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`
                };

                const response = mockResponses[prompt] || `I can help with that. Here's information about "${prompt}": 

For official documentation, please visit: 
<a href="https://www.bybit.com/en-US/" target="_blank">Bybit Official Website</a>

<div class="disclaimer-badge" onclick="showEthicsInfo()">
    <i class="fas fa-info-circle disclaimer-icon"></i>
    <span>AI-generated content - verify with official sources</span>
</div>`;

                // Simulate streaming
                const words = response.split(' ');
                const streamingElement = document.getElementById('streamingResponse');
                
                for (let i = 0; i < words.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                    fullResponse += words[i] + ' ';
                    streamingElement.innerHTML = fullResponse;
                    smoothScrollToBottom();
                }

                // Add references
                const references = getReferencesFor(prompt);
                if (references.length > 0) {
                    let referencesHTML = `
                        <div class="references">
                            <div class="references-title">Sources & References</div>
                            ${references.map(ref => `
                                <div class="reference-item" onclick="openReference('${ref.url}')">
                                    <i class="fas fa-external-link-alt reference-icon"></i>
                                    <span>${sanitize(ref.title)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    streamingElement.insertAdjacentHTML('afterend', referencesHTML);
                }

                // Finalize message
                messageHistory.push({
                    content: fullResponse,
                    sender: 'assistant',
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    references: references
                });
                
            } catch (error) {
                console.error("Mock response error:", error);
                document.getElementById('streamingResponse').innerHTML = 
                    '<span class="error-message">Error: Mock response failed</span>';
            } finally {
                hideTypingIndicator();
            }
        }

        function getReferencesFor(prompt) {
            // Comprehensive reference generation for all Bybit features
            const lowerPrompt = prompt.toLowerCase();
            
            if (lowerPrompt.includes('deposit') || lowerPrompt.includes('withdraw')) {
                return [
                    {title: 'Deposit Guide', url: 'https://www.bybit.com/en-US/help-center/article/How-to-Deposit'},
                    {title: 'Withdrawal Guide', url: 'https://www.bybit.com/en-US/help-center/article/How-to-Withdraw'}
                ];
            } else if (lowerPrompt.includes('p2p')) {
                return [
                    {title: 'P2P Trading Guide', url: 'https://www.bybit.com/en-US/p2p/'},
                    {title: 'P2P FAQ', url: 'https://www.bybit.com/en-US/help-center/bybit-p2p'}
                ];
            } else if (lowerPrompt.includes('pay')) {
                return [
                    {title: 'Bybit Pay Overview', url: 'https://www.bybit.com/en-US/pay/'},
                    {title: 'Merchant Integration', url: 'https://www.bybit.com/en-US/pay/merchant'}
                ];
            } else if (lowerPrompt.includes('kyc') || lowerPrompt.includes('verification')) {
                return [
                    {title: 'KYC Guide', url: 'https://www.bybit.com/en-US/help-center/article/KYC-Verification'},
                    {title: 'Account Security', url: 'https://www.bybit.com/en-US/help-center/article/Account-Security'}
                ];
            } else if (lowerPrompt.includes('api')) {
                return [
                    {title: 'API Documentation', url: 'https://bybit-exchange.github.io/docs/'},
                    {title: 'API FAQ', url: 'https://bybit-exchange.github.io/docs/faq'},
                    {title: 'API Status', url: 'https://bybit-exchange.github.io/docs/api-status'}
                ];
            } else if (lowerPrompt.includes('trading') || lowerPrompt.includes('pair')) {
                return [
                    {title: 'Markets Overview', url: 'https://www.bybit.com/en-US/markets/'},
                    {title: 'Trading Guide', url: 'https://www.bybit.com/en-US/help-center/category/Trading'}
                ];
            }
            return [
                {title: 'Bybit Help Center', url: 'https://www.bybit.com/en-US/help-center/'},
                {title: 'Official Documentation', url: 'https://bybit-exchange.github.io/docs/'}
            ];
        }

        function showEthicsInfo() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const ethicsMessage = `
                <div class="message assistant">
                    <div class="message-content">
                        <div class="message-header">
                            <div class="message-avatar assistant-avatar" aria-hidden="true">
                                <i class="fas fa-headset"></i>
                            </div>
                            <span>AI Transparency</span>
                        </div>
                        <div class="message-text">
                            <p><strong>About This Assistant:</strong></p>
                            <ul>
                                <li>Responses may contain AI-generated content</li>
                                <li>Always verify critical information with official sources</li>
                                <li>Not financial advice - for informational purposes only</li>
                                <li>Regularly updated with Bybit's latest documentation</li>
                            </ul>
                            <div class="references">
                                <div class="references-title">Official Resources</div>
                                <div class="reference-item" onclick="openReference('https://www.bybit.com')">
                                    <i class="fas fa-external-link-alt reference-icon"></i>
                                    <span>Bybit Official Website</span>
                                </div>
                                <div class="reference-item" onclick="openReference('https://www.bybit.com/en-US/help-center/')">
                                    <i class="fas fa-external-link-alt reference-icon"></i>
                                    <span>Bybit Help Center</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.insertAdjacentHTML('beforeend', ethicsMessage);
            smoothScrollToBottom();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;

            hideWelcomeScreen();
            addMessage(message, 'user');
            
            if (!currentChatTitle) {
                currentChatTitle = message.length > 30 ? message.substring(0, 30) + '...' : message;
                addToChatHistory(currentChatTitle);
            }
            
            input.value = '';
            input.style.height = '56px';
            showTypingIndicator();
            
            await getAIStreamResponse(message);
            saveChatHistory();
        }

        function addMessage(content, sender, references = null) {
            if (typeof content !== 'string' || !['user', 'assistant'].includes(sender)) {
                console.error('Invalid message parameters');
                return;
            }
            
            if (references && !Array.isArray(references)) {
                console.error('References must be an array');
                references = null;
            }

            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let referencesHTML = '';
            if (references && references.length > 0) {
                referencesHTML = `
                    <div class="references">
                        <div class="references-title">Sources & References</div>
                        ${references.map(ref => `
                            <div class="reference-item" onclick="openReference('${ref.url}')">
                                <i class="fas fa-external-link-alt reference-icon"></i>
                                <span>${sanitize(ref.title)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-avatar ${sender}-avatar" aria-hidden="true">
                            ${sender === 'user' ? '<i class="fas fa-user" aria-hidden="true"></i>' : '<i class="fas fa-headset" aria-hidden="true"></i>'}
                        </div>
                        <span>${sender === 'user' ? 'You' : 'Bybit Assist'}</span>
                        <span style="margin-left: auto; font-size: 12px; opacity: 0.7;">${timestamp}</span>
                    </div>
                    <div class="message-text">${sanitize(content)}</div>
                    ${referencesHTML}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            smoothScrollToBottom();
            
            messageHistory.push({content, sender, timestamp, references});
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="message-avatar assistant-avatar" aria-hidden="true">
                            <i class="fas fa-headset"></i>
                        </div>
                        <span>Assistant is thinking</span>
                        <div class="typing-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            smoothScrollToBottom();
            isTyping = true;
            
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
            }
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            isTyping = false;
            
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = false;
            }
        }

        function openReference(url) {
            window.open(url, '_blank');
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            chatContainer.innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-logo">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div class="welcome-title">Bybit Knowledge Assistant</div>
                    <div class="welcome-subtitle">
                        Get instant answers about trading, account management, API integration, and all Bybit platform features.
                    </div>
                    <div class="capabilities">
                        <div class="capability-card" onclick="askSampleQuestion('How do I deposit funds into my Bybit account?')">
                            <div class="capability-icon">
                                <i class="fas fa-money-bill-transfer"></i>
                            </div>
                            <div class="capability-title">Deposits & Withdrawals</div>
                            <div class="capability-desc">Guide to funding your account and withdrawing assets</div>
                        </div>
                        
                        <div class="capability-card" onclick="askSampleQuestion('How does Bybit P2P trading work?')">
                            <div class="capability-icon">
                                <i class="fas fa-people-arrows"></i>
                            </div>
                            <div class="capability-title">P2P Trading</div>
                            <div class="capability-desc">Learn about peer-to-peer trading on Bybit</div>
                        </div>
                        
                        <div class="capability-card" onclick="askSampleQuestion('What is Bybit Pay and how do I use it?')">
                            <div class="capability-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="capability-title">Bybit Pay</div>
                            <div class="capability-desc">Using Bybit's payment solutions</div>
                        </div>
                        
                        <div class="capability-card" onclick="askSampleQuestion('How do I complete KYC verification on Bybit?')">
                            <div class="capability-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="capability-title">Account Verification</div>
                            <div class="capability-desc">KYC process and requirements</div>
                        </div>

                        <div class="capability-card" onclick="askSampleQuestion('How do I use Bybit API for automated trading?')">
                            <div class="capability-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="capability-title">API Development</div>
                            <div class="capability-desc">Building applications with Bybit API</div>
                        </div>

                        <div class="capability-card" onclick="askSampleQuestion('What are the trading pairs available on Bybit?')">
                            <div class="capability-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="capability-title">Market Information</div>
                            <div class="capability-desc">Available trading instruments and pairs</div>
                        </div>
                    </div>
                </div>
            `;
            messageHistory = [];
            currentChatTitle = null;
            saveChatHistory();
        }

        function addToChatHistory(title) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;

            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.innerHTML = `
                <span>${sanitize(title)}</span>
                <i class="fas fa-ellipsis-v"></i>
            `;
            
            // Remove active class from other items
            chatHistory.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add new item at the top
            chatHistory.insertBefore(chatItem, chatHistory.firstChild);
            chatItem.classList.add('active');
            
            // Limit to 10 recent chats
            const chatItems = chatHistory.querySelectorAll('.chat-item');
            if (chatItems.length > 10) {
                chatItems[chatItems.length - 1].remove();
            }
        }

        function updateStats() {
            const accuracy = 98.3 + Math.random() * 0.4;
            const responseTime = 0.6 + Math.random() * 0.4;
            
            const accuracyElement = document.querySelector('.stat-value');
            const responseTimeElement = document.querySelectorAll('.stat-value')[1];
            
            if (accuracyElement) accuracyElement.textContent = accuracy.toFixed(1) + '%';
            if (responseTimeElement) responseTimeElement.textContent = responseTime.toFixed(1) + 's';
        }

        function simulateKnowledgeBaseUpdate() {
            const kbItems = document.querySelectorAll('.kb-status');
            kbItems.forEach(item => {
                if (Math.random() < 0.1) {
                    item.style.background = '#ffa502';
                    setTimeout(() => {
                        item.style.background = '#00d4aa';
                    }, 2000);
                }
            });
        }

        function smoothScrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const isNearBottom = chatContainer.scrollHeight - chatContainer.clientHeight - chatContainer.scrollTop < 100;
            
            if (isNearBottom) {
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        function saveChatHistory() {
            try {
                localStorage.setItem('bybitAssistChatHistory', JSON.stringify({
                    messages: messageHistory,
                    currentChatTitle: currentChatTitle
                }));
            } catch (e) {
                console.error('Failed to save chat history:', e);
            }
        }

        function loadChatHistory() {
            try {
                const history = localStorage.getItem('bybitAssistChatHistory');
                if (history) {
                    const data = JSON.parse(history);
                    messageHistory = data.messages || [];
                    currentChatTitle = data.currentChatTitle || null;
                    
                    if (currentChatTitle) {
                        addToChatHistory(currentChatTitle);
                    }
                    
                    // Render messages from history
                    if (messageHistory.length > 0) {
                        hideWelcomeScreen();
                        messageHistory.forEach(msg => {
                            addMessage(msg.content, msg.sender, msg.references);
                        });
                    }
                }
            } catch (e) {
                console.error('Failed to load chat history:', e);
            }
        }

        function initializeApp() {
            const onlineHandler = updateConnectionStatus;
            window.addEventListener('online', onlineHandler);
            window.addEventListener('offline', onlineHandler);
            
            cleanupFunctions.push(() => {
                window.removeEventListener('online', onlineHandler);
                window.removeEventListener('offline', onlineHandler);
            });

            const input = document.getElementById('messageInput');
            if (input) input.focus();
            
            loadChatHistory();
            updateConnectionStatus();
        }

        function updateConnectionStatus() {
            const indicator = document.querySelector('.model-indicator');
            if (!indicator) return;

            const isOnline = navigator.onLine;
            
            if (isOnline) {
                indicator.style.background = '#00d4aa';
                indicator.title = 'Connected to Mistral 7B';
            } else {
                indicator.style.background = '#ff4757';
                indicator.title = 'Connection lost';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Update stats every 30 seconds
            setInterval(updateStats, 30000);
            
            // Simulate knowledge base updates every 15 seconds
            setInterval(simulateKnowledgeBaseUpdate, 15000);
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + K to focus input
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                const input = document.getElementById('messageInput');
                if (input) input.focus();
            }
            
            // Ctrl/Cmd + N for new chat
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                clearChat();
            }
        });

        // Cleanup when needed
        function cleanup() {
            cleanupFunctions.forEach(fn => fn());
            cleanupFunctions = [];
        }

        // Make sure to cleanup when the page unloads
        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>